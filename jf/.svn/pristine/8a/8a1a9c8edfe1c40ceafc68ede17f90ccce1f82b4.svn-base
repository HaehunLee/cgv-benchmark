package kr.co.hta.controller;

import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import kr.co.hta.movies.dao.NoticeDao;
import kr.co.hta.movies.dao.TheaterDao;
import kr.co.hta.vo.Notice;
import kr.co.hta.vo.ScreeningDate;
import kr.co.hta.vo.Theater;
import kr.co.jhta.mvc.annotation.Controller;
import kr.co.jhta.mvc.annotation.RequestMapping;
import kr.co.jhta.mvc.servlet.ModelAndView;

@Controller
public class TheaterController {
	TheaterDao theaterDao = new TheaterDao(); 
	NoticeDao noticeDao = new NoticeDao();
	
	@RequestMapping("/cgv/cgvtheaters.jf")
	public ModelAndView cgvTheaters(HttpServletRequest req, HttpServletResponse res) throws Exception {
		ModelAndView mav = new ModelAndView();
		
		mav.setViewName("semi/CGVTheater/CGVtheater.jsp");
		int tno = 0;
		String city = "";
		
		try {
			tno = Integer.parseInt(req.getParameter("tno"));
			
		} catch (Exception e) {
			tno = 1;
		}
		try {
			city = req.getParameter("city");
		} catch (Exception e) {
			city = "서울";
		}
		
		List<Theater> theaters = theaterDao.getTheaterByCity(city);
		
		Theater theater = theaterDao.getTheaterByNo(tno);
		int roomsCount = theaterDao.getRoomsByTheaterNo(tno);
		int seatsCount = theaterDao.getSeatsByTheaterNo(tno);
		List<Notice> notices = noticeDao.selectAllNotice();
		List<String> cities = theaterDao.getAllCities();
		List<String> dates = theaterDao.get7DaysByTheaterNo(tno);
		List<ScreeningDate> monthAndDates = new ArrayList<>();
		
		for(String date : dates) {
			String[] words = date.split("-");
			ScreeningDate screeningDate = new ScreeningDate();
			screeningDate.setMonth(words[0]);
			screeningDate.setDate(words[1]);
			monthAndDates.add(screeningDate);
		}
		
		mav.addAttribute("theaters", theaters);
		mav.addAttribute("theater", theater);
		mav.addAttribute("cities", cities);
		mav.addAttribute("roomsCount", roomsCount);
		mav.addAttribute("seatsCount", seatsCount);
		mav.addAttribute("notices", notices);
		mav.addAttribute("monthAndDates", monthAndDates);
		
		return mav;
	}
}
